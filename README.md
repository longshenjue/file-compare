# 对账引擎 - 企业级账单对账与数据清洗平台

## 📋 目录

1. [项目简介](#项目简介)
2. [核心功能](#核心功能)
3. [快速开始](#快速开始)
4. [详细使用指南](#详细使用指南)
5. [数据清洗规则](#数据清洗规则)
6. [高级功能](#高级功能)
7. [常见问题](#常见问题)
8. [技术架构](#技术架构)
9. [开发者指南](#开发者指南)

---

## 项目简介

这是一个基于 **Tauri + Vue 3 + Rust + DuckDB** 构建的企业级对账引擎桌面应用。主要用于跨境支付场景下的账单对账，支持复杂的数据清洗、字段映射和状态归一化。

### 核心特性

- ✅ **本地化处理**：所有数据处理在本地完成，保护数据隐私
- ⚡ **高性能**：使用 DuckDB 处理大规模数据（支持数十万行）
- 🔄 **灵活的数据清洗**：支持 10+ 种预设清洗算法
- 🎯 **精准对账**：自动识别完全匹配、金额差异、单边账
- 📊 **结果导出**：支持分类导出 CSV 格式结果
- 💾 **配置管理**：保存和复用对账配置，提高效率
- 📈 **历史数据对账**：支持跨日期范围对账，消除时间延迟导致的单边账
- 🔍 **Double Check**：扩大时间范围重新对账，进一步减少单边账
- 📦 **订单管理**：上传、存储和查询订单数据

---

## 技术栈

### 前端
- Vue 3 + TypeScript
- Tailwind CSS
- Tauri API

### 后端
- Rust
- DuckDB (内存数据库，bundled 特性)
- CSV 处理

---

## 快速开始

### 安装与运行

#### 开发环境

```bash
# 安装依赖
npm install

# 开发模式
npm run tauri dev
```

#### 生产构建

```bash
# 构建应用
npm run tauri build
```

构建产物位于：`src-tauri/target/release/bundle/`

### 5 分钟快速体验

使用项目提供的示例数据快速体验完整流程：

1. **启动应用**：`npm run tauri dev`
2. **创建配置**：主页 → 渠道解析配置 → 新建配置
3. **执行对账**：主页 → 执行对账 → 选择配置 → 上传文件
4. **查看结果**：查看对账结果并导出

详细测试步骤请参考：`sample_data/README.md`

---

## 详细使用指南

### 方式一：配置管理流程（推荐）

#### 1. 创建渠道配置

**步骤 1：基本信息**
- 配置名称：如 "VIDI-LT 支付渠道"
- 数据源A名称：如 "内部订单系统"
- 数据源B名称：如 "VIDI银行对账单"
- 类型：PAYOUT（付款）或 PAYIN（收款）
- Header 行号：CSV 文件中标题所在行（从 1 开始）
- 时区：选择时间字段的时区（默认 America/Sao_Paulo）
- 去重：勾选后根据 ID 字段自动去重

**步骤 2：数据源A字段映射**

为订单文件配置字段映射：

- **源列名**：CSV 中的原始列名（如：`transaction_date`, `e2e`, `status`, `amount`）
- **类型**：
  - `OrderTime`：时间字段
  - `OrderStatus`：状态字段
  - `OrderString`：字符串字段（如订单 ID）
  - `OrderAmount`：金额字段
- **字段名**：映射后的标准字段名（如：`sourceATime`, `sourceAId`, `sourceAStatus`, `sourceAAmount`）
- **规则类型**：数据处理规则（如 `ORDER_TIME_NORMAL`, `ORDER_STRING_NORMAL`）
- **格式规则**（可选）：数据清洗规则，支持 Pre（前置）和 Post（后置）处理

**步骤 3：数据源B字段映射**

与步骤 2 相同，为银行文件配置字段映射。

**步骤 4：匹配配置**

- **数据源A ID 字段**：选择用于关联的字段（如：`sourceAId`）
- **数据源A状态映射**：配置状态归一化（如：`PAID, COMPLETED, SUCCESS → PAID`）
- **数据源B ID 字段**：选择银行的 ID 字段（如：`sourceBId`）
- **数据源B状态映射**：配置银行状态归一化
- **历史数据对账选项**（可选）：
  - 使用历史数据源A：勾选后对账时加载前后 N 天的历史订单
  - 使用历史数据源B：勾选后对账时加载前后 N 天的历史银行流水
  - 历史数据时间范围：设置前后天数（默认 5 天，建议 5-10 天）

**保存配置**：配置完成后点击"保存配置"，配置会持久化到本地文件系统。

#### 2. 执行对账

1. **选择配置**：从配置列表中选择已保存的配置
2. **上传文件**：
   - 上传数据源A文件（订单文件）
   - 上传数据源B文件（银行文件）
   - 设置日期范围
3. **执行对账**：点击"执行对账"按钮
4. **查看结果**：查看对账结果并导出

### 方式二：快速对账流程

如果不想保存配置，也可以使用快速对账流程：

1. 主页 → 执行对账
2. 选择"快速对账"模式
3. 按照 6 步骤流程完成对账（配置不会保存）

---

## 数据清洗规则

### 字符串处理

#### DEL_PRE（删除前缀）
```
原始：ABC123
规则：DEL_PRE → 3
结果：123
```

#### DEL_AFTER（保留前缀，删除后缀）⭐ 最常用
```
原始：E2E-004_SUFFIX
规则：DEL_AFTER → 7
结果：E2E-004
```
💡 这是最常用的规则，用于删除 ID 后缀

#### DEL_CHAR（删除字符）
```
原始：12-34-56
规则：DEL_CHAR → -
结果：123456
```

#### REPLACE_TWO_CHAR（替换字符）
```
原始：order_id_123
规则：REPLACE_TWO_CHAR → _,:
结果：order:id:123
```
💡 格式：`from,to`（用逗号分隔）

#### BRA_VALUE（提取括号内容）
```
原始：[E2E-123]
规则：BRA_VALUE
结果：E2E-123
```

#### ADD_CHAR_PRE（前置添加）
```
原始：123
规则：ADD_CHAR_PRE → ID_
结果：ID_123
```

#### ADD_CHAR_AFTER（后置添加）
```
原始：E2E
规则：ADD_CHAR_AFTER → _001
结果：E2E_001
```

### 数值处理

#### DIVIDE_NUMBER（除法）
```
原始：1000（分）
规则：DIVIDE_NUMBER → 100
结果：10（元）
```
💡 适用于货币单位转换

#### ABS_VALUE（绝对值）
```
原始：-100
规则：ABS_VALUE
结果：100
```
💡 适用于退款/出账记录

### 时间处理

#### XENDIT_TIME（Xendit 时间格式转换）
```
原始：2025-12-30T10:30:00
规则：XENDIT_TIME
结果：2025-12-30 10:30:00
```

### 规则叠加

可以同时使用多个规则：

```
原始：[E2E-004_SUFFIX]
规则1：Pre → BRA_VALUE → （提取括号）
规则2：Pre → DEL_AFTER → 7（删除后缀）
结果：E2E-004
```

---

## 高级功能

### 1. 配置管理

#### 配置导入导出

- **导出配置**：在配置列表中点击"导出"按钮，保存为 JSON 文件
- **导入配置**：点击"导入配置"按钮，选择 JSON 文件导入
- **配置位置**：`~/.file-compare/reconciliation_configs/configs.json`

#### 配置复用

- 相同渠道的不同时间段可以使用同一配置
- 配置保存后可以重复使用，无需重新配置

### 2. 历史数据对账 ⭐

**使用场景**：解决跨日对账问题

在跨境支付场景中，订单可能在 12 月 1 日创建，但银行流水在 12 月 2 日才到账，导致单边账。

**解决方案**：

在配置的第 4 步"匹配配置"中启用历史数据对账：

- **使用历史数据源A**：对账时自动加载前后 N 天的历史订单
- **使用历史数据源B**：对账时自动加载前后 N 天的历史银行流水
- **历史数据时间范围**：设置前后天数（默认 5 天，建议 5-10 天）

**工作原理**：

假设今天对账 2025-12-30 的数据，历史范围设置为 5 天：

- 不启用：仅加载 2025-12-30 的数据
- 启用历史数据：加载 2025-12-25 ~ 2025-12-30 共 6 天的历史数据
- 系统自动去重，不用担心重复数据

### 3. Double Check 功能 🔄

**使用场景**：对账后发现较多单边账，怀疑是时间延迟导致

**操作步骤**：

1. 主页 → 对账历史
2. 点击某个任务查看详情
3. 在详情页面，点击"执行 Double Check"按钮
4. 设置扩大的时间范围（例如前后 10 天）
5. 系统会重新加载扩大范围的历史数据进行对账
6. 生成新的对账结果并保存为新任务

**效果对比**：

```
第一次对账（不使用历史数据）：
  完全匹配: 1500 条
  仅订单: 200 条
  仅银行: 150 条

Double Check（扩大到前后10天）：
  完全匹配: 1780 条  ← 增加了 280 条！
  仅订单: 50 条      ← 减少了 150 条
  仅银行: 20 条      ← 减少了 130 条
```

### 4. 对账历史记录

**功能说明**：

- 每次对账自动生成任务记录
- 查看所有历史任务
- 点击任务查看详细对账结果
- 支持导出任意历史任务的数据

**任务记录包含**：

- 任务ID、任务名称
- 配置信息、文件信息
- 对账统计（完全匹配、单边账、金额差异）
- 是否使用了历史数据
- 创建时间
- 完整的对账结果数据

### 5. 订单管理

**功能说明**：

- 上传订单文件并保存到本地
- 查看所有已上传文件
- 条件查询（等于、包含、大于、小于）
- 删除不需要的文件

**使用场景**：

- 历史订单归档
- 快速查询订单
- 数据预处理和质量检查

**操作步骤**：

1. 主页 → 订单管理
2. 选择配置和文件类型
3. 上传 CSV 文件（自动解析和清洗）
4. 在文件列表中点击"查看/查询"
5. 设置查询条件并查询

**清除数据**：

- **清除所有订单数据**：点击"清除所有订单数据"按钮，永久删除所有已上传的订单文件
- **清除历史数据**：点击"清除历史数据"按钮，删除指定日期之前的数据

---

## 常见问题

### Q1：为什么上传文件后没有反应？

**A**：检查以下几点：
- CSV 文件格式是否正确
- Header 行号是否设置正确
- 文件大小是否过大（建议 < 50MB）
- 控制台是否有错误信息

### Q2：对账结果全部是"仅订单存在"

**A**：可能原因：
1. ID 字段映射错误
2. ID 格式不一致（需要添加清洗规则）
3. 选择的 ID 字段不是用于关联的字段

**解决方法**：
- 检查订单和银行的 ID 字段是否对应
- 使用 DEL_AFTER、REPLACE_TWO_CHAR 等规则统一格式

### Q3：状态匹配不上

**A**：可能原因：
1. 状态映射配置不完整
2. 输入状态时拼写错误
3. 源文件中的状态不在映射列表中

**解决方法**：
- 仔细检查源文件中所有可能的状态
- 在状态映射中添加所有状态值
- 使用大写并检查是否有空格

### Q4：金额总是不匹配

**A**：可能原因：
1. 金额单位不同（分 vs 元）
2. 金额字段类型不是 OrderAmount
3. 金额格式不同（如带货币符号）

**解决方法**：
- 使用 DIVIDE_NUMBER 转换单位
- 使用 DEL_CHAR 删除货币符号
- 确保字段类型设置为 OrderAmount

### Q5：如何处理退款记录？

**A**：两种方式：
1. **分开处理**：正常订单和退款分别对账
2. **统一处理**：
   - 使用 ABS_VALUE 将金额统一为正数
   - 在状态映射中区分 PAID 和 REFUNDED

### Q6：历史数据对账和 Double Check 有什么区别？

**A**：
- **历史数据对账**：配置中启用，每次对账自动生效
- **Double Check**：事后操作，针对已有的对账结果重新执行

**建议策略**：
- 如果每天都需要跨日对账：在配置中启用历史数据
- 如果偶尔需要排查问题：使用 Double Check

### Q7：历史数据会占用多少空间？

**A**：取决于文件大小：
- 小文件（<1000行）：约 100KB/天
- 中等文件（1万行）：约 1MB/天
- 大文件（10万行）：约 10MB/天

建议保留 30 天历史数据，约 300MB-3GB。

### Q8：遇到数据格式错误怎么办？

**A**：如果遇到数据格式错误，可以清除旧数据：

```bash
# macOS/Linux
rm -rf ~/.file-compare

# Windows
rmdir /s /q %APPDATA%\.file-compare
```

或者使用应用内的数据重置功能。

### Q9：订单查询中列名与数据对不上怎么办？

**A**：这通常是因为历史数据中的字段名与当前配置不一致。解决方法：

1. **清除所有订单数据**：在订单管理页面点击"清除所有订单数据"按钮
2. **重新上传文件**：使用当前配置重新上传订单文件
3. **检查配置**：确保配置中的字段名正确（如 `sourceAId`, `sourceBId` 等）

### Q10：Double Check 功能报错"字段不存在"怎么办？

**A**：这通常是因为配置中的字段名与历史数据中的字段名不一致。解决方法：

1. **清除历史数据**：清除所有订单数据，重新上传
2. **检查配置**：确保配置中的 ID 字段名正确（如 `sourceAId`, `sourceBId`）
3. **查看错误提示**：系统会显示可用的字段名列表，根据提示修正配置

---

## 技术架构

### 系统架构

```
┌─────────────────────────────────────────────┐
│            Vue 3 前端界面                    │
│  (HomePage + ConfigEditor + ReconcilePage)  │
└─────────────────┬───────────────────────────┘
                  │ Tauri IPC
┌─────────────────▼───────────────────────────┐
│             Rust 后端核心                    │
│  ┌──────────────────────────────────────┐   │
│  │   DataProcessor (DuckDB)             │   │
│  │   - load_csv_to_table                │   │
│  │   - apply_data_cleaning              │   │
│  │   - normalize_status                 │   │
│  │   - perform_reconciliation           │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │   ConfigManager                      │   │
│  │   - 配置保存/加载/导入/导出           │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │   HistoryManager                     │   │
│  │   - 历史数据管理                      │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │   TaskManager                        │   │
│  │   - 任务记录管理                      │   │
│  └──────────────────────────────────────┘   │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│          DuckDB 内存数据库                   │
│  - SQL JOIN                                 │
│  - 数据清洗                                  │
│  - 去重                                      │
│  - 历史数据存储                              │
└─────────────────────────────────────────────┘
```

### 数据存储结构

```
~/.file-compare/
  ├── reconciliation_configs/      # 渠道配置
  │   └── configs.json
  ├── history/                     # 历史订单数据
  │   ├── config-id_sourceA_2025-12-30.json
  │   └── config-id_sourceB_2025-12-30.json
  ├── tasks/                       # 对账任务记录
  │   ├── tasks.json               # 任务列表
  │   └── task_xxx_result.json     # 任务详细结果
  └── orders/                      # 订单管理数据
      ├── index.json               # 文件索引
      └── file_{id}.json           # 订单数据文件
```

---

## 开发者指南

### 添加新的清洗算法

在 `src-tauri/src/processor.rs` 的 `apply_format_rule` 方法中添加：

```rust
"YOUR_RULE" => {
    // 实现规则逻辑
    format!("SQL_EXPRESSION({})", column_expr)
}
```

### 扩展导出格式

在 `src-tauri/src/exporter.rs` 中添加新的导出函数。

### 项目结构

```
file-compare/
├── src/                          # Vue 前端
│   ├── components/               # Vue 组件
│   │   ├── HomePage.vue          # 主页
│   │   ├── ConfigList.vue        # 配置列表
│   │   ├── ConfigEditor.vue      # 配置编辑器
│   │   ├── ReconcilePage.vue     # 对账执行页面
│   │   ├── TaskList.vue          # 对账历史列表
│   │   ├── TaskDetail.vue        # 对账结果详情
│   │   └── OrderManagement.vue   # 订单管理
│   ├── types/                    # TypeScript 类型
│   │   └── index.ts
│   └── main.ts                   # 入口文件
│
├── src-tauri/                    # Rust 后端
│   ├── src/
│   │   ├── models.rs            # 数据模型
│   │   ├── processor.rs         # 数据处理
│   │   ├── exporter.rs          # 结果导出
│   │   ├── config_manager.rs    # 配置管理
│   │   ├── history_manager.rs   # 历史数据管理
│   │   ├── task_manager.rs      # 任务管理
│   │   ├── order_manager.rs       # 订单管理
│   │   ├── lib.rs               # Tauri 命令
│   │   └── main.rs              # 程序入口
│   └── Cargo.toml               # Rust 依赖
│
├── sample_data/                  # 示例数据
│   ├── orders_sample.csv
│   ├── bank_sample.csv
│   └── README.md
│
└── sample_configs/               # 配置示例
    └── VIDI-LT-PAYOUT.json
```

---

## 版本信息

**当前版本**：v3.2.3  
**发布日期**：2025-12-31  
**状态**：稳定

### 主要功能

- ✅ 配置管理系统（导入/导出）
- ✅ 历史数据对账
- ✅ Double Check 功能（已修复字段名验证）
- ✅ 对账历史记录
- ✅ 订单管理模块（支持清除所有数据）
- ✅ 10+ 种数据清洗算法
- ✅ CSV 智能导出（字段过滤）

### 最新修复

- ✅ 修复 Double Check 功能中的字段名验证问题
- ✅ 添加清除所有订单数据的功能
- ✅ 改进历史数据加载时的表结构创建
- ✅ 增强字段名验证和错误提示
- ✅ **修复表格列名和列顺序问题**：统一列名顺序，确保表头和数据列对齐
- ✅ **修复时间戳显示格式**：自动识别并格式化时间戳为可读的时间格式

---

## 许可证

MIT

---

## 支持与反馈

如有问题或建议，请：

1. 查看示例数据说明：`sample_data/README.md`
2. 查看配置示例：`sample_configs/VIDI-LT-PAYOUT.json`
3. 检查错误日志和控制台输出

**祝您对账顺利！** 🎉
